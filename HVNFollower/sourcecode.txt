using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Windows.Forms;
using System.Runtime.InteropServices;
using Microsoft.Win32;
using System.Diagnostics;
using System.Text.RegularExpressions;

namespace HVNFollower
{
    public partial class DsChuThot : Form
    {
        public DsChuThot()
        {
            InitializeComponent();
        }

        void exportRegistry(string strKey, string filepath)
        {
            try
            {
                using (Process proc = new Process())
                {
                    proc.StartInfo.FileName = "reg.exe";
                    proc.StartInfo.UseShellExecute = false;
                    proc.StartInfo.RedirectStandardOutput = true;
                    proc.StartInfo.RedirectStandardError = true;
                    proc.StartInfo.CreateNoWindow = true;
                    proc.StartInfo.Arguments = "export \"" + strKey + "\" \"" + filepath + "\" /y";
                    proc.Start();
                    string stdout = proc.StandardOutput.ReadToEnd();
                    string stderr = proc.StandardError.ReadToEnd();
                    proc.WaitForExit();
                    MessageBox.Show("Sao lưu danh sách thành công!\n\nĐường dẫn tệp tin sao lưu là:\n" + saveFileDialog1.FileName + "\n\nĐể chuyển nó sang máy tính khác, chỉ cần nhấn đúp vào tệp tin đã sao lưu, nhấn OK và khởi động lại HVN Follower.", "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("Có lỗi trong khi sao lưu. Vui lòng thử lại.\nThông tin lỗi:\n" + ex.ToString(), "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void DsChuThot_Load(object sender, EventArgs e)
        {
            RegistryKey rk = Registry.CurrentUser.CreateSubKey("SOFTWARE\\LilShieru\\HVNFollower");
            if (rk.GetValueNames().Count() == 0)
            {
                listBox1.Items.Add("Không có Chủ thớt nào được thêm.");
                listBox1.Enabled = false;
                button1.Enabled = false;
                button2.Enabled = false;
            }
            foreach (string value in rk.GetValueNames())
            {
                listBox1.Items.Add("ID: " + value + " (Tên hiển thị: " + rk.GetValue(value, "Không rõ") + ")");
            }
            RegistryKey rk2 = Registry.CurrentUser.CreateSubKey("SOFTWARE\\LilShieru\\HVNFollower\\Authors");
            if (rk2.GetValueNames().Count() == 0)
            {
                listBox2.Items.Add("Không có Tác giả nào được thêm.");
                listBox2.Enabled = false;
                button4.Enabled = false;
                button5.Enabled = false;
            }
            foreach (string value in rk2.GetValueNames())
            {
                listBox2.Items.Add(rk2.GetValue(value, "Không rõ"));
            }
        }

        private void button3_Click(object sender, EventArgs e)
        {
            if (saveFileDialog1.ShowDialog() == DialogResult.OK)
            {
                exportRegistry("HKEY_CURRENT_USER\\SOFTWARE\\LilShieru\\HVNFollower", saveFileDialog1.FileName);
            }
        }

        private void button1_Click(object sender, EventArgs e)
        {
            try
            {
                string tempSelectedName = listBox1.SelectedItem.ToString().Substring(listBox1.SelectedItem.ToString().IndexOf("ị:") + 3);
                string selectedName = tempSelectedName.Remove(tempSelectedName.Length - 1);
                if (MessageBox.Show("Xóa Chủ thớt " + selectedName + "?", "Xác nhận", MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.Yes)
                {
                    try
                    {
                        RegistryKey rk = Registry.CurrentUser.CreateSubKey("SOFTWARE\\LilShieru\\HVNFollower");
                        string tempselectedID = listBox1.SelectedItem.ToString().Substring(0, listBox1.SelectedItem.ToString().IndexOf("(") - 1);
                        string selectedID = tempselectedID.Substring(tempselectedID.IndexOf(":") + 2);
                        rk.DeleteValue(selectedID, false);
                        System.IO.File.Delete(Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData) + "\\LilShieru\\HVNFollower\\" + selectedID + ".tmp");
                        MessageBox.Show("Xóa Chủ thớt thành công.", "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    }
                    catch
                    {
                        MessageBox.Show("Có lỗi trong khi xóa Chủ thớt. Vui lòng thử lại.", "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    }
                }
            }
            catch
            {
                MessageBox.Show("Chưa chọn Chủ thớt nào.", "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Information);
            }
        }

        private void button2_Click(object sender, EventArgs e)
        {
            if (MessageBox.Show("Xóa tất cả các Chủ thớt?", "Xác nhận", MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.Yes)
            {
                RegistryKey rk = Registry.CurrentUser.CreateSubKey("SOFTWARE\\LilShieru\\HVNFollower");
                try
                {
                    foreach (string value in rk.GetValueNames())
                    {
                        rk.DeleteValue(value, false);
                        System.IO.File.Delete(Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData) + "\\LilShieru\\HVNFollower\\" + value + ".tmp");
                    }
                    MessageBox.Show("Xóa tất cả Chủ thớt thành công.", "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Information);
                }

                catch
                {
                    MessageBox.Show("Có lỗi trong khi xóa Chủ thớt. Vui lòng thử lại.", "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }

        private void button4_Click(object sender, EventArgs e)
        {
            try
            {
                string selectedName = listBox2.SelectedItem.ToString();
                if (MessageBox.Show("Xóa Tác giả " + selectedName + "?", "Xác nhận", MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.Yes)
                {
                    try
                    {
                        RegistryKey rk2 = Registry.CurrentUser.CreateSubKey("SOFTWARE\\LilShieru\\HVNFollower\\Authors");
                        string selectedID = listBox2.SelectedItem.ToString().Replace(" ", "+");
                        rk2.DeleteValue(selectedID, false);
                        System.IO.File.Delete(Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData) + "\\LilShieru\\HVNFollower\\" + selectedID + ".tmp");
                        MessageBox.Show("Xóa Tác giả thành công.", "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    }
                    catch
                    {
                        MessageBox.Show("Có lỗi trong khi xóa Chủ thớt. Vui lòng thử lại.", "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    }
                }
            }
            catch
            {
                MessageBox.Show("Chưa chọn Tác giả nào.", "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Information);
            }
        }

        private void button5_Click(object sender, EventArgs e)
        {
            if (MessageBox.Show("Xóa tất cả các Tác giả?", "Xác nhận", MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.Yes)
            {
                RegistryKey rk = Registry.CurrentUser.CreateSubKey("SOFTWARE\\LilShieru\\HVNFollower\\Authors");
                try
                {
                    foreach (string value in rk.GetValueNames())
                    {
                        rk.DeleteValue(value, false);
                        System.IO.File.Delete(Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData) + "\\LilShieru\\HVNFollower\\" + value + ".tmp");
                    }
                    MessageBox.Show("Xóa tất cả Tác giả thành công.", "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Information);
                }

                catch
                {
                    MessageBox.Show("Có lỗi trong khi xóa các Tác giả. Vui lòng thử lại.", "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }
    }
}
